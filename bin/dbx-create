#!/usr/bin/env bash
# Create a distrobox/toolbox from a profile file and optionally preinstall packages.

set -euo pipefail
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)
# shellcheck source=../lib/common.sh
. "$SCRIPT_DIR/../lib/common.sh"

PROFILE=""
NAME_OVERRIDE=""
IMAGE_OVERRIDE=""
VOLUMES=()
YES=0
GUI_OVERRIDE=""
SYSTEM_BUS_OVERRIDE=""

usage() {
  cat <<EOF
dbx-create <toolboxes/profile.ini> [--name NAME] [--image IMAGE] [--volume SRC:DST[:opt]] [--yes] [--gui] [--system-bus]
Profile keys:
  NAME=           default container name
  IMAGE=          container image (docker/podman syntax)
  INIT=0|1        pass --init to distrobox
  EXTRA_ARGS=     extra flags to distrobox create
  ADDITIONAL_FLAGS= flags passed to podman via distrobox --additional-flags
  PREINSTALL=     space separated packages to install after creation
  GUI=0|1         if 1, add common GUI passthrough devices (/dev/dri, /dev/input)
  GUI_SYSTEM_BUS=0|1 if 1, bind-mount /run/dbus/system_bus_socket (host must provide it)
EOF
  exit 1
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    -h|--help) usage;;
    --name) NAME_OVERRIDE=$2; shift 2;;
    --image) IMAGE_OVERRIDE=$2; shift 2;;
    --volume) VOLUMES+=("$2"); shift 2;;
    --yes|-y) YES=1; shift;;
    --gui) GUI_OVERRIDE=1; shift;;
    --system-bus) SYSTEM_BUS_OVERRIDE=1; shift;;
    *) if [ -z "$PROFILE" ]; then PROFILE=$1; shift; else usage; fi;;
  esac
done

[ -n "$PROFILE" ] || usage
[ -f "$PROFILE" ] || die "profile not found: $PROFILE"

ensure_commands distrobox podman

# shellcheck disable=SC1090
. "$PROFILE"

NAME=${NAME_OVERRIDE:-${NAME:-}}
IMAGE=${IMAGE_OVERRIDE:-${IMAGE:-}}
INIT=${INIT:-1}
EXTRA_ARGS=${EXTRA_ARGS:-}
ADDITIONAL_FLAGS=${ADDITIONAL_FLAGS:-}
PREINSTALL=${PREINSTALL:-}
GUI=${GUI_OVERRIDE:-${GUI:-0}}
GUI_SYSTEM_BUS=${SYSTEM_BUS_OVERRIDE:-${GUI_SYSTEM_BUS:-0}}

[ -n "$NAME" ] || die "profile missing NAME"
[ -n "$IMAGE" ] || die "profile missing IMAGE"

if podman container exists "$NAME"; then
  die "container $NAME already exists"
fi

args=(create --name "$NAME" --image "$IMAGE")
[ "$INIT" -eq 1 ] && args+=(--init)
[ -n "$EXTRA_ARGS" ] && args+=($EXTRA_ARGS)

if [ "$GUI" -eq 1 ] 2>/dev/null; then
  # Common GPU + input passthrough for Wayland compositors.
  gui_flags="--device /dev/dri --device /dev/input"
  if [ -n "$ADDITIONAL_FLAGS" ]; then
    ADDITIONAL_FLAGS="$ADDITIONAL_FLAGS $gui_flags"
  else
    ADDITIONAL_FLAGS="$gui_flags"
  fi
fi

if [ "$GUI_SYSTEM_BUS" -eq 1 ] 2>/dev/null; then
  require_system_bus_socket /run/dbus/system_bus_socket
  VOLUMES+=("/run/dbus/system_bus_socket:/run/dbus/system_bus_socket")
fi

[ -n "$ADDITIONAL_FLAGS" ] && args+=(--additional-flags "$ADDITIONAL_FLAGS")
for v in "${VOLUMES[@]}"; do args+=(--volume "$v"); done

log "distrobox ${args[*]}"
if [ "$YES" -eq 1 ]; then
  distrobox "${args[@]}"
else
  distrobox "${args[@]}" </dev/tty
fi

if [ -n "$PREINSTALL" ]; then
  log "preinstalling: $PREINSTALL"
  # Intentional word-splitting of PREINSTALL into package args.
  # shellcheck disable=SC2086
  pkg_install_if_missing_in_box "$NAME" $PREINSTALL
fi

log "container $NAME ready"
